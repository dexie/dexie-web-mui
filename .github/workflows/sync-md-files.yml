name: Sync MD Files to old dexie-website

on:  
  push:
    branches: [main]
    paths: ['**/*.md']

jobs:
  sync-md-files:
    if: false  # Workflow disabled temporarily when removing old docs
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Get changed MD files
      id: changed-files
      run: |
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep '\.md$' || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          echo "No .md files have been changed"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Changed .md files:"
        echo "$CHANGED_FILES"
        echo "has_changes=true" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" > changed_files.txt

    - name: Generate patches for changed files
      if: steps.changed-files.outputs.has_changes == 'true'
      run: |
        mkdir -p patches
        
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            echo "Creating patch for: $file"
            # Create patch with minimal context (1 line) and ignore whitespace
            git diff -U1 --ignore-space-change HEAD~1 HEAD -- "$file" > "patches/${file//\//_}.patch"
            
            if [ -s "patches/${file//\//_}.patch" ]; then
              echo "Patch created for $file"
            else
              echo "Empty patch for $file"
              rm -f "patches/${file//\//_}.patch"
            fi
          fi
        done < changed_files.txt
        
        ls -la patches/ || echo "No patches were created"

    - name: Checkout target repository
      if: steps.changed-files.outputs.has_changes == 'true'
      uses: actions/checkout@v4
      with:
        repository: dexie/dexie-website
        token: ${{ secrets.TARGET_REPO_TOKEN }}
        path: target-repo

    - name: Apply patches to target repository
      if: steps.changed-files.outputs.has_changes == 'true'
      run: |
        cd target-repo
        
        git config user.name "GitHub Action"
        git config user.email "action@github.com"
        
        APPLIED_PATCHES=()
        FAILED_PATCHES=()
        
        for patch_file in ../patches/*.patch; do
          if [ -f "$patch_file" ]; then
            original_file=$(basename "$patch_file" .patch | tr '_' '/')
            
            # Transform docs/cloud/ paths to cloud/docs/ in target repo
            if [[ "$original_file" == docs/cloud/* ]]; then
              target_file="cloud/docs/${original_file#docs/cloud/}"
              echo "Transforming path: $original_file -> $target_file"
            else
              target_file="$original_file"
            fi
            
            echo "Attempting to apply patch for: $original_file (target: $target_file)"
            
            if [ -f "$target_file" ]; then
              # Try with minimal context and ignore whitespace
              if git apply --unidiff-zero --ignore-whitespace "$patch_file" 2>/dev/null; then
                git add "$target_file"
                APPLIED_PATCHES+=("$target_file")
                echo "✓ Patch applied for: $target_file"
              else
                echo "⚠ Standard patch failed, trying 3-way merge..."
                
                if git apply --3way --ignore-whitespace "$patch_file" 2>/dev/null; then
                  git add "$target_file"
                  APPLIED_PATCHES+=("$target_file (3-way merge)")
                  echo "✓ 3-way merge succeeded for: $target_file"
                else
                  echo "⚠ 3-way merge failed, trying with fuzz factor..."
                  
                  # Try using patch command with fuzz factor as last resort
                  if patch -p1 --fuzz=3 "$target_file" < "$patch_file" 2>/dev/null; then
                    git add "$target_file"
                    APPLIED_PATCHES+=("$target_file (fuzzy match)")
                    echo "✓ Fuzzy patch succeeded for: $target_file"
                  else
                    echo "✗ All patch methods failed for: $target_file"
                    FAILED_PATCHES+=("$target_file")
                  fi
                fi
              fi
            else
              echo "⚠ Target file does not exist: $target_file"
              mkdir -p "$(dirname "$target_file")"
              if git apply "$patch_file" 2>/dev/null; then
                git add "$target_file"
                APPLIED_PATCHES+=("$target_file (new file)")
                echo "✓ New file created: $target_file"
              else
                echo "✗ Could not create new file: $target_file"
                FAILED_PATCHES+=("$target_file")
              fi
            fi
          fi
        done
        
        echo "=== SUMMARY ==="
        echo "Applied patches: ${#APPLIED_PATCHES[@]}"
        for file in "${APPLIED_PATCHES[@]}"; do
          echo "  ✓ $file"
        done
        
        echo "Failed patches: ${#FAILED_PATCHES[@]}"
        for file in "${FAILED_PATCHES[@]}"; do
          echo "  ✗ $file"
        done
        
        if [ ${#APPLIED_PATCHES[@]} -gt 0 ]; then
          APPLIED_LIST=$(printf '%s, ' "${APPLIED_PATCHES[@]}" | sed 's/, $//')
          git commit -m "Sync MD files from dexie-web - Applied patches for: $APPLIED_LIST - Source commit: ${{ github.sha }}"
          git push
          echo "Changes committed and pushed!"
        else
          echo "No changes to commit"
        fi