"use client"

import React from "react"
import {
  Typography,
  Box,
  Link,
  List,
  ListItem,
  ListItemText,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Divider,
} from "@mui/material"
import dynamic from "next/dynamic"
import parse, { domToReact, Element, DOMNode } from 'html-react-parser'

const CodeBlock = dynamic(() => import("../shared/CodeBlock"), { ssr: false })

interface MDXContentProps {
  source: string
}

// Convert HTML attributes to MUI props
function convertProps(props: Record<string, any>) {
  const { style, className, ...rest } = props
  const converted: Record<string, any> = { ...rest }

  if (className) {
    converted.className = className
  }

  if (style) {
    converted.sx = parseStyleString(style)
  }

  return converted
}

// Parse inline style string to MUI sx object
function parseStyleString(styleString: string | undefined): Record<string, string> {
  if (!styleString) return {}

  const styles: Record<string, string> = {}
  const declarations = styleString.split(';').filter(s => s.trim())

  declarations.forEach(declaration => {
    const [property, value] = declaration.split(':').map(s => s.trim())
    if (property && value) {
      // Convert CSS property names to camelCase
      const camelProperty = property.replace(/-([a-z])/g, (_, letter) => letter.toUpperCase())
      styles[camelProperty] = value
    }
  })

  return styles
}

// Custom HTML parser that converts HTML to MUI components
function parseHTMLToComponents(html: string): React.ReactNode {
  const options = {
    replace: (domNode: Element | { type: string; data: string }) => {
      if (domNode instanceof Element) {
        const { name, attribs, children } = domNode

        switch (name) {
          case 'h1':
            return (
              <Typography
                key={Math.random()}
                variant="h1"
                component="h1"
                gutterBottom
                {...convertProps(attribs || {})}
              >
                {domToReact(children as DOMNode[], options)}
              </Typography>
            )
          case 'h2':
            return (
              <Typography
                key={Math.random()}
                variant="h2"
                component="h2"
                gutterBottom
                sx={{ mt: 4 }}
                {...convertProps(attribs || {})}
              >
                {domToReact(children as DOMNode[], options)}
              </Typography>
            )
          case 'h3':
            return (
              <Typography
                key={Math.random()}
                variant="h3"
                component="h3"
                gutterBottom
                sx={{ mt: 3 }}
                {...convertProps(attribs || {})}
              >
                {domToReact(children, options)}
              </Typography>
            )
          case 'h4':
            return (
              <Typography
                key={Math.random()}
                variant="h4"
                component="h4"
                gutterBottom
                sx={{ mt: 3 }}
                {...convertProps(attribs || {})}
              >
                {domToReact(children, options)}
              </Typography>
            )
          case 'p':
            return (
              <Typography
                key={Math.random()}
                variant="body1"
                component="div"
                paragraph
                {...convertProps(attribs || {})}
              >
                {domToReact(children, options)}
              </Typography>
            )
          case 'a':
            const href = attribs?.href
            const isExternal =
              href &&
              (href.startsWith("http://") ||
                href.startsWith("https://") ||
                href.startsWith("//") ||
                (!href.startsWith("/") &&
                  !href.startsWith("#") &&
                  !href.startsWith("?")))

            const linkProps = isExternal
              ? {
                  target: "_blank",
                  rel: "noopener noreferrer",
                  ...convertProps(attribs || {}),
                }
              : convertProps(attribs || {})

            return (
              <Link
                key={Math.random()}
                href={href}
                color="primary"
                sx={{ fontWeight: 600 }}
                underline="hover"
                {...linkProps}
              >
                {domToReact(children, options)}
              </Link>
            )
          case 'ul':
            return (
              <List
                key={Math.random()}
                sx={{
                  mb: 3,
                  listStyleType: "disc",
                  pl: 2,
                  "& .MuiListItem-root": {
                    display: "list-item",
                    pl: 0,
                  },
                }}
                {...convertProps(attribs || {})}
              >
                {domToReact(children, options)}
              </List>
            )
          case 'ol':
            return (
              <List
                key={Math.random()}
                component="ol"
                sx={{
                  mb: 3,
                  pl: 2,
                  listStyleType: "decimal",
                  "& .MuiListItem-root": {
                    display: "list-item",
                    pl: 0,
                  },
                }}
                {...convertProps(attribs || {})}
              >
                {domToReact(children, options)}
              </List>
            )
          case 'li':
            return (
              <ListItem
                key={Math.random()}
                sx={{
                  py: 0.25,
                  display: "list-item",
                  pl: 0,
                }}
                {...convertProps(attribs || {})}
              >
                <ListItemText
                  primary={
                    <Typography component="span" variant="body1">
                      {domToReact(children, options)}
                    </Typography>
                  }
                  sx={{ m: 0 }}
                />
              </ListItem>
            )
          case 'pre':
            // For code blocks, let the code component handle it
            return <>{domToReact(children, options)}</>
          case 'code':
            const className = attribs?.class
            // Check if this is inside a pre element
            const isInPre = domNode.parent && (domNode.parent as Element).name === 'pre'

            if (isInPre) {
              // This is a code block from markdown (```language)
              const match = /language-(\w+)/.exec(className || "")
              const language = match ? match[1] : "javascript"
              const codeString = domToReact(children, options)?.toString() || ""

              return (
                <Box
                  key={Math.random()}
                  sx={{
                    mb: 3,
                    background: "rgba(255, 255, 255, 0.1)",
                    borderRadius: 2,
                    border: "1px solid rgba(255, 255, 255, 0.15)",
                    pr: 2,
                    mt: 2,
                  }}
                >
                  <CodeBlock
                    language={language}
                    code={codeString}
                    showLineNumbers={true}
                  />
                </Box>
              )
            } else {
              // Inline code
              return (
                <Box
                  key={Math.random()}
                  component="code"
                  sx={{
                    fontFamily: "monospace",
                    fontSize: "0.875rem",
                    backgroundColor: "rgba(255, 255, 255, 0.1)",
                    px: 1,
                    py: 0.5,
                    borderRadius: 1,
                  }}
                  {...convertProps(attribs || {})}
                >
                  {domToReact(children, options)}
                </Box>
              )
            }
          case 'blockquote':
            return (
              <Paper
                key={Math.random()}
                component="blockquote"
                elevation={0}
                sx={{
                  borderLeft: 4,
                  borderColor: "primary.main",
                  pl: 3,
                  mb: 3,
                  py: 1,
                  backgroundColor: "grey.50",
                  color: "text.secondary",
                }}
                {...convertProps(attribs || {})}
              >
                <Typography component="div">{domToReact(children, options)}</Typography>
              </Paper>
            )
          case 'table':
            return (
              <TableContainer
                key={Math.random()}
                component={Paper}
                sx={{
                  mb: 3,
                  width: "fit-content",
                  maxWidth: "100%",
                }}
                {...convertProps(attribs || {})}
              >
                <Table>{domToReact(children, options)}</Table>
              </TableContainer>
            )
          case 'thead':
            return <TableHead key={Math.random()} {...convertProps(attribs || {})}>{domToReact(children, options)}</TableHead>
          case 'tbody':
            return <TableBody key={Math.random()} {...convertProps(attribs || {})}>{domToReact(children, options)}</TableBody>
          case 'tr':
            return <TableRow key={Math.random()} {...convertProps(attribs || {})}>{domToReact(children, options)}</TableRow>
          case 'th':
            return (
              <TableCell key={Math.random()} component="th" {...convertProps(attribs || {})}>
                <Typography variant="subtitle2" component="span">
                  {domToReact(children, options)}
                </Typography>
              </TableCell>
            )
          case 'td':
            return <TableCell key={Math.random()} {...convertProps(attribs || {})}>{domToReact(children, options)}</TableCell>
          case 'img':
            return (
              <Box
                key={Math.random()}
                component="img"
                src={attribs?.src}
                alt={attribs?.alt || ""}
                sx={{
                  maxWidth: "100%",
                  height: "auto",
                  borderRadius: 1,
                  mb: 3,
                }}
                {...convertProps(attribs || {})}
              />
            )
          case 'div':
            return (
              <Box key={Math.random()} component="div" {...convertProps(attribs || {})}>
                {domToReact(children, options)}
              </Box>
            )
          case 'span':
            return (
              <Box key={Math.random()} component="span" {...convertProps(attribs || {})}>
                {domToReact(children, options)}
              </Box>
            )
          case 'hr':
            return (
              <Divider
                key={Math.random()}
                sx={{ my: 3 }}
                {...convertProps(attribs || {})}
              />
            )
          default:
            return React.createElement(
              name,
              {
                key: Math.random(),
                ...convertProps(attribs || {}),
              },
              domToReact(children, options)
            )
        }
      }
    },
  }

  return parse(html, options)
}

export default function MDXContent({ source }: MDXContentProps) {
  const content = parseHTMLToComponents(source)

  return (
    <Box className="mdx-content" sx={{ maxWidth: 'none' }}>
      {content}
    </Box>
  )
}
